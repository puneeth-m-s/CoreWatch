{% extends "base.html" %}

{% block title %}CPU Monitor - Corewatch{% endblock %}
{% block page_title %}CPU Monitoring{% endblock %}

{% block content %}
<div class="row mb-4">
    <!-- Metric cards -->
    <div class="col-md-3">
        <div class="card metric-card">
            <div class="card-body text-center">
                <i class="fas fa-microchip fa-2x mb-2"></i>
                <div class="metric-value" id="cpu-usage">--</div>
                <div class="metric-label">Overall Usage</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card metric-card">
            <div class="card-body text-center">
                <i class="fas fa-tachometer-alt fa-2x mb-2"></i>
                <div class="metric-value" id="cpu-freq">--</div>
                <div class="metric-label">Frequency (MHz)</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card metric-card">
            <div class="card-body text-center">
                <i class="fas fa-layer-group fa-2x mb-2"></i>
                <div class="metric-value" id="cpu-cores">--</div>
                <div class="metric-label">CPU Cores</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card metric-card">
            <div class="card-body text-center">
                <i class="fas fa-thermometer-half fa-2x mb-2"></i>
                <div class="metric-value" id="cpu-temp">--</div>
                <div class="metric-label">Temperature</div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <!-- CPU usage history chart -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-line"></i> CPU Usage History</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="cpuChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <!-- Per-core usage -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-list"></i> Per-Core Usage</h5>
            </div>
            <div class="card-body" id="per-core-usage" style="max-height: 300px; overflow-y: auto;">
                <div class="text-muted text-center">Loading...</div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- CPU Info -->
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-info-circle"></i> CPU Information</h5>
            </div>
            <div class="card-body">
                <div class="row" id="cpu-info">
                    <div class="text-muted text-center">Loading CPU information...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Top CPU Processes -->
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-tasks"></i> Top CPU Processes</h5>
            </div>
            <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                <table class="table table-sm table-striped" id="cpu-table">
                    <thead>
                        <tr>
                            <th>PID</th>
                            <th>Process</th>
                            <th>CPU %</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="3" class="text-center text-muted">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let cpuChart;

    function initializeCharts() {
        const ctx = document.getElementById('cpuChart').getContext('2d');
        cpuChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'CPU Usage %',
                    data: [],
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }

    function updateSystemData(data) {
        const info = data.system_info;
        
        document.getElementById('cpu-usage').textContent = info.cpu.percent.toFixed(1) + '%';
        document.getElementById('cpu-cores').textContent = info.cpu.count;
        
        if (info.cpu.frequency) {
            document.getElementById('cpu-freq').textContent = info.cpu.frequency.current.toFixed(0);
        }

        let cpuTemp = '--';
        for (const [sensorName, sensors] of Object.entries(info.temperatures)) {
            if (sensorName.toLowerCase().includes('cpu') || sensorName.toLowerCase().includes('core')) {
                for (const sensor of sensors) {
                    cpuTemp = sensor.current.toFixed(1) + 'Â°C';
                    break;
                }
                break;
            }
        }
        document.getElementById('cpu-temp').textContent = cpuTemp;

        const perCoreContainer = document.getElementById('per-core-usage');
        if (info.cpu.per_cpu && info.cpu.per_cpu.length > 0) {
            let coreHtml = '';
            info.cpu.per_cpu.forEach((usage, index) => {
                coreHtml += `
                    <div class="mb-2">
                        <div class="d-flex justify-content-between">
                            <span>Core ${index}</span>
                            <span>${usage.toFixed(1)}%</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar ${getProgressClass(usage)}" style="width: ${usage}%"></div>
                        </div>
                    </div>
                `;
            });
            perCoreContainer.innerHTML = coreHtml;
        }

        const cpuInfoContainer = document.getElementById('cpu-info');
        cpuInfoContainer.innerHTML = `
            <div class="col-md-6">
                <h6>Processor</h6>
                <p class="text-muted">${info.system.processor || 'Unknown'}</p>
                
                <h6>Architecture</h6>
                <p class="text-muted">${info.system.architecture ? info.system.architecture.join(', ') : 'Unknown'}</p>
            </div>
            <div class="col-md-6">
                <h6>Platform</h6>
                <p class="text-muted">${info.system.platform}</p>
                
                <h6>Boot Time</h6>
                <p class="text-muted">${new Date(info.system.boot_time * 1000).toLocaleString()}</p>
            </div>
        `;

        if (cpuChart && data.history && data.history.cpu) {
            const labels = data.history.cpu.map(item => new Date(item.timestamp).toLocaleTimeString());
            cpuChart.data.labels = labels;
            cpuChart.data.datasets[0].data = data.history.cpu.map(item => item.value);
            cpuChart.update('none');
        }
    }

    function loadProcesses() {
        fetch('/cpu_processes')
            .then(response => response.json())
            .then(data => {
                let tbody = document.querySelector('#cpu-table tbody');
                tbody.innerHTML = '';
                data.sort((a, b) => b.cpu_percent - a.cpu_percent)
                    .forEach(proc => {
                        tbody.innerHTML += `
                            <tr>
                                <td>${proc.pid}</td>
                                <td>${proc.name}</td>
                                <td>${proc.cpu_percent.toFixed(1)}</td>
                            </tr>
                        `;
                    });
            });
    }

    function getProgressClass(value) {
        if (value >= 80) return 'bg-danger';
        if (value >= 50) return 'bg-warning';
        return 'bg-success';
    }

    document.addEventListener('DOMContentLoaded', function() {
        initializeCharts();
        setInterval(loadProcesses, 2000);
    });
</script>
{% endblock %}