{% extends "base.html" %}

{% block title %}Alerts - Corewatch{% endblock %}
{% block page_title %}System Alerts{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-exclamation-triangle"></i> Alert Configuration</h5>
                <button class="btn btn-primary btn-sm" onclick="showConfigModal()">
                    <i class="fas fa-cog"></i> Configure Thresholds
                </button>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 text-center">
                        <div class="alert alert-info">
                            <i class="fas fa-microchip fa-2x"></i>
                            <h6 class="mt-2">CPU Threshold</h6>
                            <strong id="cpu-threshold">95%</strong>
                        </div>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="alert alert-info">
                            <i class="fas fa-tv fa-2x"></i>
                            <h6 class="mt-2">GPU Threshold</h6>
                            <strong id="gpu-threshold">95%</strong>
                        </div>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="alert alert-warning">
                            <i class="fas fa-battery-quarter fa-2x"></i>
                            <h6 class="mt-2">Battery Threshold</h6>
                            <strong id="battery-threshold">10%</strong>
                        </div>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="alert alert-warning">
                            <i class="fas fa-thermometer-full fa-2x"></i>
                            <h6 class="mt-2">Temperature Threshold</h6>
                            <strong id="temp-threshold">40°C</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-bell"></i> Active Alerts</h5>
                <div>
                    <span class="badge bg-danger me-2" id="critical-count">0</span>
                    <span class="badge bg-warning" id="warning-count">0</span>
                </div>
            </div>
            <div class="card-body" id="active-alerts" style="max-height: 400px; overflow-y: auto;">
                <div class="text-muted text-center">No active alerts</div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-history"></i> Alert History</h5>
            </div>
            <div class="card-body" id="alert-history" style="max-height: 400px; overflow-y: auto;">
                <div class="text-muted text-center">No alert history</div>
            </div>
        </div>
    </div>
</div>

<!-- Configuration Modal -->
<div class="modal fade" id="configModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-cog"></i> Alert Configuration</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="cpu-threshold-input" class="form-label">CPU Usage Threshold (%)</label>
                    <input type="number" class="form-control" id="cpu-threshold-input" value="95" min="1" max="100">
                </div>
                <div class="mb-3">
                    <label for="gpu-threshold-input" class="form-label">GPU Usage Threshold (%)</label>
                    <input type="number" class="form-control" id="gpu-threshold-input" value="95" min="1" max="100">
                </div>
                <div class="mb-3">
                    <label for="battery-threshold-input" class="form-label">Battery Level Threshold (%)</label>
                    <input type="number" class="form-control" id="battery-threshold-input" value="10" min="1" max="50">
                </div>
                <div class="mb-3">
                    <label for="temp-threshold-input" class="form-label">Temperature Threshold (°C)</label>
                    <input type="number" class="form-control" id="temp-threshold-input" value="40" min="20" max="100">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveConfiguration()">Save Changes</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let alertHistory = [];

    function showConfigModal() {
        new bootstrap.Modal(document.getElementById('configModal')).show();
    }

    function saveConfiguration() {
        // In a real application, you would send these to the server
        const cpuThreshold = document.getElementById('cpu-threshold-input').value;
        const gpuThreshold = document.getElementById('gpu-threshold-input').value;
        const batteryThreshold = document.getElementById('battery-threshold-input').value;
        const tempThreshold = document.getElementById('temp-threshold-input').value;

        // Update display
        document.getElementById('cpu-threshold').textContent = cpuThreshold + '%';
        document.getElementById('gpu-threshold').textContent = gpuThreshold + '%';
        document.getElementById('battery-threshold').textContent = batteryThreshold + '%';
        document.getElementById('temp-threshold').textContent = tempThreshold + '°C';

        // Close modal
        bootstrap.Modal.getInstance(document.getElementById('configModal')).hide();

        // Show success message
        const alert = document.createElement('div');
        alert.className = 'alert alert-success alert-dismissible fade show';
        alert.innerHTML = `
            <i class="fas fa-check-circle"></i> Alert thresholds updated successfully!
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.querySelector('.container-fluid .row .col-md-10').insertBefore(alert, document.querySelector('.container-fluid .row .col-md-10').firstChild);
    }

    function updateSystemData(data) {
        if (data.alerts) {
            // Update active alerts
            const activeAlertsContainer = document.getElementById('active-alerts');
            const criticalCount = data.alerts.filter(alert => alert.severity === 'critical').length;
            const warningCount = data.alerts.filter(alert => alert.severity === 'warning').length;

            document.getElementById('critical-count').textContent = criticalCount;
            document.getElementById('warning-count').textContent = warningCount;

            if (data.alerts.length > 0) {
                let alertsHtml = '';
                data.alerts.forEach(alert => {
                    const alertClass = alert.severity === 'critical' ? 'alert-danger' : 'alert-warning';
                    const iconClass = alert.severity === 'critical' ? 'fas fa-exclamation-circle' : 'fas fa-exclamation-triangle';
                    
                    alertsHtml += `
                        <div class="alert ${alertClass} d-flex align-items-center" role="alert">
                            <i class="${iconClass} me-2"></i>
                            <div class="flex-grow-1">
                                <strong>${alert.type.toUpperCase()}:</strong> ${alert.message}
                                <br><small class="text-muted">${new Date(alert.timestamp).toLocaleString()}</small>
                            </div>
                            <span class="badge bg-${alert.severity === 'critical' ? 'danger' : 'warning'}">${alert.severity}</span>
                        </div>
                    `;
                });
                activeAlertsContainer.innerHTML = alertsHtml;

                // Add to history (avoid duplicates)
                data.alerts.forEach(alert => {
                    const alertKey = `${alert.type}_${alert.timestamp}`;
                    if (!alertHistory.some(h => h.key === alertKey)) {
                        alertHistory.unshift({
                            key: alertKey,
                            ...alert
                        });
                    }
                });

                // Keep only last 50 alerts in history
                if (alertHistory.length > 50) {
                    alertHistory = alertHistory.slice(0, 50);
                }
            } else {
                activeAlertsContainer.innerHTML = '<div class="text-muted text-center">No active alerts</div>';
            }

            // Update alert history
            const historyContainer = document.getElementById('alert-history');
            if (alertHistory.length > 0) {
                let historyHtml = '';
                alertHistory.forEach(alert => {
                    const alertClass = alert.severity === 'critical' ? 'border-danger' : 'border-warning';
                    const iconClass = alert.severity === 'critical' ? 'fas fa-exclamation-circle text-danger' : 'fas fa-exclamation-triangle text-warning';
                    
                    historyHtml += `
                        <div class="card mb-2 ${alertClass}" style="border-left: 4px solid;">
                            <div class="card-body py-2">
                                <div class="d-flex align-items-center">
                                    <i class="${iconClass} me-2"></i>
                                    <div class="flex-grow-1">
                                        <strong>${alert.type.toUpperCase()}:</strong> ${alert.message}
                                        <br><small class="text-muted">${new Date(alert.timestamp).toLocaleString()}</small>
                                    </div>
                                    <span class="badge bg-${alert.severity === 'critical' ? 'danger' : 'warning'}">${alert.severity}</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
                historyContainer.innerHTML = historyHtml;
            } else {
                historyContainer.innerHTML = '<div class="text-muted text-center">No alert history</div>';
            }
        }
    }
</script>
{% endblock %}
